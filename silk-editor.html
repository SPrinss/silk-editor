<link rel="import" href="bower_components/polymer/polymer.html">

<!--
Silk editor: [GitHub](https://github.com/woutervroege/silk-editor)

`silk-editor` is a is a richt text editor
-->

<dom-module id="silk-editor">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }
            article {
                outline: none;
            }
            .formatting-bar {
                position: absolute;
                z-index: 2;
                overflow:hidden;
                background-color: black;
                font-size: 0;
                border-radius: 3px;
                box-sizing: border-box;
            }

            button {
                border:0;
                background-color: transparent;
                color: white;
                font-size:14px;
                cursor: pointer;
                width: 36px;
                height: 36px;
                outline: none;
            }

            button:hover {
                background-color: rgba(255,0,0,.3);
            }

            button[selected], button:active {
                background-color: rgba(255,0,0,1);
            }
        </style>
        <section class="formatting-bar" hidden$="[[!selectedText]]">
            <button
                on-tap="_toggleBold"
                selected$="[[_selectedTextIsBold(selectedText, article)]]"><b>B</b></button>
            <button
                on-tap="_toggleItalic"
                selected$="[[_selectedTextIsItalic(selectedText, article)]]"><i>i</i></button>
            <button
                on-tap="_toggleUnderline"
                selected$="[[_selectedTextIsUnderlined(selectedText, article)]]"><u>U</u></button>
            <button
                on-tap="_toggleStrikeThrough"
                selected$="[[_selectedTextIsStrikedThrough(selectedText, article)]]"><s>S</s></button>
            <button on-tap="insertH1">h1</button>
            <button on-tap="insertH2">h2</button>
            <button on-tap="insertH3">h3</button>
            <button on-tap="insertH4">h4</button>
            <button on-tap="insertH5">h5</button>
            <button on-tap="insertH6">h6</button>
            <button on-tap="insertLink">&#60;a&#62;</button>
        </section>
        <article
            spellcheck$="[[checkSpelling]]"
            on-focus="_disableSpellcheck"
            on-paste="_stripHTML"
            on-mouseup="_mouseUpHandler"
            on-input="_updateContent"
            contenteditable$="[[!disabled]]"><content></content></article>
    </template>
    <script>
        Polymer({
            is: "silk-editor",
            properties: {
                disabled: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                checkSpelling: {
                    type: Boolean,
                    value: false
                },
                selection: {
                    type: Object
                },
                selectedText: {
                    type: String,
                    value: null,
                    readOnly: true,
                    notify: true
                },
                article: {
                    type: String,
                    readOnly: true
                }
            },

            _mouseUpHandler: function() {
                var formattingBarPosition = this.getFormattingBarPosition();
                $formattingBar = this.$$(".formatting-bar");
                $formattingBar.style.top = (formattingBarPosition.top) + "px";
                $formattingBar.style.left = formattingBarPosition.left + "px";
            },

            _disableSpellcheck: function() {
                if(!this.checkSpelling) document.body.spellcheck = false;
            },

            _stripHTML: function(e) {
                if (e.originalEvent && e.originalEvent.clipboardData && e.originalEvent.clipboardData.getData) {
                    e.preventDefault();
                    var text = e.originalEvent.originalEvent.clipboardData.getData("text/plain");
                    window.document.execCommand("insertText", false, text);
                }
                else if (e.clipboardData && e.clipboardData.getData) {
                    e.preventDefault();
                    var text = e.clipboardData.getData("text/plain");
                    window.document.execCommand("insertText", false, text);
                }
                else if (window.clipboardData && window.clipboardData.getData) {
                    if (!_onPaste_StripFormatting_IEPaste) {
                        _onPaste_StripFormatting_IEPaste = true;
                        e.preventDefault();
                        window.document.execCommand("ms-pasteTextOnly", false);
                    }
                    _onPaste_StripFormatting_IEPaste = false;
                }
            },

            _toggleBold: function() {
                document.execCommand("Bold")
            },

            _toggleItalic: function() {
                document.execCommand("Italic")
            },

            _toggleUnderline: function() {
                document.execCommand("Underline")
            },

            _toggleStrikeThrough: function() {
                document.execCommand("StrikeThrough")
            },

            insertH1: function() {
                this.addHTML("h1");
            },

            insertH2: function() {
                this.addHTML("h2");
            },

            insertH3: function() {
                this.addHTML("h3");
            },

            insertH4: function() {
                this.addHTML("h4");
            },

            insertH5: function() {
                this.addHTML("h5");
            },

            insertH6: function() {
                this.addHTML("h6");
            },

            insertLink: function() {
                var link = window.prompt("Please add a link", "http://");
                document.execCommand("insertHTML", false, "<a href=\""+link+"\">"+this.selectedText+"</a>");
            },

            getSelection: function() {
               var selection = "";

                if (window.getSelection) {  // all browsers, except IE before version 9
                    if (document.activeElement && (document.activeElement.tagName.toLowerCase() == "textarea" || document.activeElement.tagName.toLowerCase() == "input")) {
                        var text = document.activeElement.value;
                        selection = text.substring(document.activeElement.selectionStart, document.activeElement.selectionEnd);
                    }
                    else {
                        selection = window.getSelection();
                    }
                }
                else {
                    if (document.selection.createRange) { // Internet Explorer
                        selection = document.selection.createRange();
                    }
                }
                this._setSelectedText(selection.toString() || selection.text);
                return selection;
            },

            getSelectionRange: function() {
                return this.getSelection().getRangeAt(0);
            },

            getFormattingBarPosition: function() {
                var range = this.getSelectionRange();
                if (range.getClientRects()[0].width === 0 && range.getClientRects()[1]) {
                    var topPosition = range.getClientRects()[1].top + document.body.scrollTop;
                    var leftPosition = range.startContainer.parentElement.offsetLeft;
                } else {
                    var topPosition = range.getClientRects()[0].top + document.body.scrollTop;
                    var leftPosition = range.getClientRects()[0].left;                    
                }
                topPosition -= this.getArticleFontSize()*3;
                return {
                    top: topPosition,
                    left: leftPosition
                }
            },

            getArticleFontSize: function() {
                var getComputedStyles = window.getComputedStyle || document.defaultView.getComputedStyle;
                var computedStylesForArticle = getComputedStyles(this.$$("article"));
                var fontSize = computedStylesForArticle.getPropertyValue("font-size");
                return parseInt(fontSize.replace("px", ""));
            },

            addHTML: function(elementName) {
                if(!this.selectedText || this.selectedText.length === 0) return;
                document.execCommand("insertHTML", false, "<" + elementName + ">" + this.selectedText + "</" + elementName + ">")
            },
            _selectedTextIsBold: function() {
                return document.queryCommandState("Bold");
            },
            _selectedTextIsItalic: function() {
                return document.queryCommandState("Italic");                
            },
            _selectedTextIsUnderlined: function() {
                return document.queryCommandState("Underline");                
            },
            _selectedTextIsStrikedThrough: function() {
                return document.queryCommandState("StrikeThrough");                
            },

            _updateContent: function() {
                this._setArticle(this.$$("article").innerHTML);
            }

        })
    </script>
</dom-module>