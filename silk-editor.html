<link rel="import" href="bower_components/polymer/polymer.html">

<!--
Silk editor: [GitHub](https://github.com/woutervroege/silk-editor)

`silk-editor` is a is a richt text editor
-->

<dom-module id="silk-editor">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }
            article {
                outline: none;
            }
            .formatting-bar {
                position: absolute;
                z-index: 2;
                overflow:hidden;
                background-color: rgba(0,0,0,.9);
                font-size: 0;
                border-radius: 3px;
                box-sizing: border-box;
                white-space: nowrap;
            }

            .formatting-bar[hidden] {
                opacity: 0;
            }

            .formatting-bar:not([hidden]) {
                pointer-events: all;
                animation: formattingBarIn 0.2s;
            }

            button {
                border:0;
                background-color: transparent;
                color: white;
                font-size:16px;
                cursor: pointer;
                width: 40px;
                height: 40px;
                outline: none;
            }

            button:hover {
                background-color: rgba(255,0,0,.3);
            }

            button[selected], button:active {
                background-color: rgba(247,120,107,1);
                color: black;
            }

            @-webkit-keyframes formattingBarIn {
                0%{
                    opacity: 0;
                    transform: translateY(50%);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @-moz-keyframes formattingBarIn {
                0%{
                    opacity: 0;
                    transform: translateY(50%);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @-o-keyframes formattingBarIn {
                0%{
                    opacity: 0;
                    transform: translateY(50%);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @keyframes formattingBarIn {
                0%{
                    opacity: 0;
                    transform: translateY(50%);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
        <section class="formatting-bar" hidden$="[[!selectedText]]">
            <button
                on-tap="toggleBold"
                hidden$="[[!settings.bold]]"
                selected$="[[_selectedTextIsBold(selectedText, article)]]"><b>B</b></button>
            <button
                on-tap="toggleItalics"
                hidden$="[[!settings.italics]]"
                selected$="[[_selectedTextIsItalic(selectedText, article)]]"><i>i</i></button>
            <button
                on-tap="toggleUnderline"
                hidden$="[[!settings.underline]]"
                selected$="[[_selectedTextIsUnderlined(selectedText, article)]]"><u>U</u></button>
            <button
                on-tap="toggleStrikeThrough"
                hidden$="[[!settings.strikethrough]]"
                selected$="[[_selectedTextIsStrikeThrough(selectedText, article)]]"><s>S</s></button>
            <button
                on-tap="insertH1"
                hidden$="[[!settings.h1]]">h1</button>
            <button
                on-tap="insertH2"
                hidden$="[[!settings.h2]]">h2</button>
            <button
                on-tap="insertH3"
                hidden$="[[!settings.h3]]">h3</button>
            <button
                on-tap="insertH4"
                hidden$="[[!settings.h4]]">h4</button>
            <button
                on-tap="insertH5"
                hidden$="[[!settings.h5]]">h5</button>
            <button
                on-tap="insertH6"
                hidden$="[[!settings.h6]]">h6</button>
            <button
                on-tap="toggleLink"
                hidden$="[[!settings.link]]"
                hidden$="[[!settings.link]]"
                selected$="[[_selectedTextHasLink(selectedText, article)]]">&#60;a&#62;</button>
        </section>
        <article
            spellcheck$="[[checkSpelling]]"
            on-focus="_disableSpellcheck"
            on-paste="_pasteHTML"
            on-mouseup="_mouseUpHandler"
            on-input="_updateContent"
            contenteditable$="[[!disabled]]"><content></content></article>
    </template>
    <script>
        Polymer({
            is: "silk-editor",
            properties: {
                disabled: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                checkSpelling: {
                    type: Boolean,
                    value: false
                },
                selection: {
                    type: Object
                },
                selectedText: {
                    type: String,
                    value: null,
                    readOnly: true,
                    notify: true
                },
                article: {
                    type: String,
                    readOnly: true,
                    notify: true
                },
                formattingOptions: {
                    type: String,
                    value: "bold,italics,underline,strikethrough,h1,h2,h3,h4,h5,h6,link"
                },
                settings: {
                    type: Object,
                    computed: "_parseSettings(formattingOptions)"
                }
            },

            ready: function() {
                window.onresize = this._mouseUpHandler.bind(this);
            },
            _parseSettings: function(formattingOptions) {
                var settings = {};
                var options = formattingOptions.toLowerCase().replace(/\s/g, "").split(/,/g);
                settings["bold"] = options.indexOf("bold") !== -1;
                settings["italics"] = options.indexOf("italics") !== -1;
                settings["underline"] = options.indexOf("underline") !== -1;
                settings["strikethrough"] = options.indexOf("strikethrough") !== -1;
                settings["h1"] = options.indexOf("h1") !== -1;
                settings["h2"] = options.indexOf("h2") !== -1;
                settings["h3"] = options.indexOf("h3") !== -1;
                settings["h4"] = options.indexOf("h4") !== -1;
                settings["h5"] = options.indexOf("h5") !== -1;
                settings["h6"] = options.indexOf("h6") !== -1;
                settings["link"] = options.indexOf("link") !== -1;
                return settings;
            },

            toggleBold: function() {
                if(!this.settings.bold) return console.warn("bold is disabled!");
                document.execCommand("Bold")
            },

            toggleItalics: function() {
                if(!this.settings.italics) return console.warn("italics is disabled!");
                document.execCommand("Italic")
            },

            toggleUnderline: function() {
                if(!this.settings.underline) return console.warn("underline is disabled!");
                document.execCommand("Underline")
            },

            toggleStrikeThrough: function() {
                if(!this.settings.strikethrough) return console.warn("strikethrough is disabled!");
                document.execCommand("StrikeThrough")
            },

            insertH1: function() {
                if(!this.settings.h1) return console.warn("h1 is disabled!");
                this._addHTML("h1");
            },

            insertH2: function() {
                if(!this.settings.h2) return console.warn("h2 is disabled!");
                this._addHTML("h2");
            },

            insertH3: function() {
                if(!this.settings.h3) return console.warn("h3 is disabled!");
                this._addHTML("h3");
            },

            insertH4: function() {
                if(!this.settings.h4) return console.warn("h4 is disabled!");
                this._addHTML("h4");
            },

            insertH5: function() {
                if(!this.settings.h5) return console.warn("h5 is disabled!");
                this._addHTML("h5");
            },

            insertH6: function() {
                if(!this.settings.h6) return console.warn("h6 is disabled!");
                this._addHTML("h6");
            },

            toggleLink: function() {
                if(!this.settings.link) return console.warn("link is disabled!");
                var selectedElement = this._getSelectionRange().startContainer.parentElement;
                var url = window.prompt("Please add a link", selectedElement.href || "http://");
                if(!url || url.length === 0) return this.removeLink();
                else this.insertLink(url);
            },

            insertLink: function(url) {
                if(!this.settings.link) return console.warn("link is disabled!");
                document.execCommand("insertHTML", false, "<a href=\""+url+"\">"+this.selectedText+"</a>");
            },

            removeLink: function() {
                if(!this.settings.link) return console.warn("link is disabled!");
                document.execCommand("unlink", false);
            },

            _getSelection: function() {
               var selection = "";

                if (window.getSelection) {  // all browsers, except IE before version 9
                    if (document.activeElement && (document.activeElement.tagName.toLowerCase() == "textarea" || document.activeElement.tagName.toLowerCase() == "input")) {
                        var text = document.activeElement.value;
                        selection = text.substring(document.activeElement.selectionStart, document.activeElement.selectionEnd);
                    }
                    else {
                        selection = window.getSelection();
                    }
                }
                else {
                    if (document.selection.createRange) { // Internet Explorer
                        selection = document.selection.createRange();
                    }
                }
                this._setSelectedText(selection.toString() || selection.text);
                return selection;
            },

            _getSelectionRange: function() {
                return this._getSelection().getRangeAt(0);
            },

            _getFormattingBarPosition: function() {
                var range = this._getSelectionRange();
                if(!range.getClientRects()[0]) return;
                if (range.getClientRects()[0].width === 0 && range.getClientRects()[1]) {
                    var topPosition = range.getClientRects()[1].top + document.body.scrollTop;
                    var leftPosition = range.startContainer.parentElement.offsetLeft;
                } else {
                    var topPosition = range.getClientRects()[0].top + document.body.scrollTop;
                    var leftPosition = range.getClientRects()[0].left;                    
                }
                topPosition -= (this._getArticleFontSize()*2 + this._getArticleLineHeight());
                return {
                    top: topPosition,
                    left: leftPosition
                }
            },

            _mouseUpHandler: function() {
                var formattingBarPosition = this._getFormattingBarPosition();
                if(! formattingBarPosition) return;
                $formattingBar = this.$$(".formatting-bar");
                $formattingBar.style.top = (formattingBarPosition.top) + "px";
                $formattingBar.style.left = formattingBarPosition.left + "px";
            },

            _disableSpellcheck: function() {
                if(!this.checkSpelling) document.body.spellcheck = false;
            },

            _pasteHTML: function(e) {
                if (e.originalEvent && e.originalEvent.clipboardData && e.originalEvent.clipboardData.getData) {
                    e.preventDefault();
                    var html = e.originalEvent.originalEvent.clipboardData.getData("text/html");
                    window.document.execCommand("insertHTML", false, html);
                }
                else if (e.clipboardData && e.clipboardData.getData) {
                    e.preventDefault();
                    var html = this._stripTags(e.clipboardData.getData("text/html"), "<a>");
                    window.document.execCommand("insertHTML", false, html);
                }
                else if (window.clipboardData && window.clipboardData.getData) {
                    if (!_onPaste_StripFormatting_IEPaste) {
                        _onPaste_StripFormatting_IEPaste = true;
                        e.preventDefault();
                        window.document.execCommand("ms-pasteTextOnly", false);
                    }
                    _onPaste_StripFormatting_IEPaste = false;
                }
            },

            _stripTags: function(input, allowed) {
                allowed = (((allowed || '') + '')
                    .toLowerCase()
                    .match(/<[a-z][a-z0-9]*>/g) || [])
                    .join('');
                var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
                return this._stripAttributes(input.replace(tags, function($0, $1) {
                    return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
                }), "href");
            },

            _stripAttributes: function(input, allowed) {
                allowed = ((allowed || "") + "")
                    .toLowerCase()
                    .split(/,/g);
                var attributes = /\s(([a-z]|[0-9]|\-)+=".*?")/gi;
                return input.replace(attributes, function(input, attribute) {
                    var attributeName = attribute.replace(/^(.*?)=.*?$/, "$1");
                    return allowed.indexOf(attributeName.toLowerCase()) > -1 ? input : '';
                });
            },

            _getArticleFontSize: function() {
                var getComputedStyles = window.getComputedStyle || document.defaultView.getComputedStyle;
                var computedStylesForArticle = getComputedStyles(this.$$("article"));
                var fontSize = computedStylesForArticle.getPropertyValue("font-size");
                return parseInt(fontSize.replace("px", ""));
            },

            _getArticleLineHeight: function() {
                var getComputedStyles = window.getComputedStyle || document.defaultView.getComputedStyle;
                var computedStylesForArticle = getComputedStyles(this.$$("article"));
                var lineHeight = computedStylesForArticle.getPropertyValue("line-height");
                return parseInt(lineHeight.replace("px", ""));
            },

            _addHTML: function(elementName) {
                if(!this.selectedText || this.selectedText.length === 0) return;
                document.execCommand("insertHTML", false, "<" + elementName + ">" + this.selectedText + "</" + elementName + ">")
            },
            _selectedTextIsBold: function() {
                return document.queryCommandState("Bold");
            },
            _selectedTextIsItalic: function() {
                return document.queryCommandState("Italic");                
            },
            _selectedTextIsUnderlined: function() {
                return document.queryCommandState("Underline");                
            },
            _selectedTextIsStrikeThrough: function() {
                return document.queryCommandState("StrikeThrough");                
            },
            _selectedTextHasLink: function() {
                if(!this._getSelectionRange()) return false;
                var selectedElement = this._getSelectionRange().startContainer.parentElement;
                return (selectedElement.href && selectedElement.href.length > 0);
            },

            _selectedTextHasTag: function(tagName) {
                if(!this._getSelectionRange()) return false;
                var selectedElement = this._getSelectionRange().startContainer.parentElement;
                return selectedElement.nodeName.toLowerCase() === tagName;
            },

            _selectedTextHasHeading: function() {
                return (this._selectedTextHasH1() || this._selectedTextHasH2() || this._selectedTextHasH3() || this._selectedTextHasH4() || this._selectedTextHasH5() || this._selectedTextHasH6())
            },

            _selectedTextHasH1: function() {
                return this._selectedTextHasTag("h1");
            },

            _selectedTextHasH2: function() {
                return this._selectedTextHasTag("h2");
            },

            _selectedTextHasH3: function() {
                return this._selectedTextHasTag("h3");
            },

            _selectedTextHasH4: function() {
                return this._selectedTextHasTag("h4");
            },

            _selectedTextHasH5: function() {
                return this._selectedTextHasTag("h5");
            },

            _selectedTextHasH6: function() {
                return this._selectedTextHasTag("h6");
            },

            _updateContent: function() {
                this._setArticle(this.$$("article").innerHTML);
            }

        })
    </script>
</dom-module>
