<link rel="import" href="bower_components/polymer/polymer.html">

<!--
Silk editor: [GitHub](https://github.com/woutervroege/silk-editor)

`silk-editor` is a is a richt text editor
-->

<dom-module id="silk-editor">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }
            article {
                outline: none;
            }

            .formatting-bar {
                position: fixed;
                z-index: 2;
                overflow:hidden;
                background-color: rgba(0,0,0,.9);
                font-size: 0;
                border-radius: 3px;
                box-sizing: border-box;
                white-space: nowrap;
            }

            .formatting-bar[hidden] {
                opacity: 0;
            }

            .formatting-bar:not([hidden]) {
                pointer-events: all;
                animation: formattingBarIn 0.2s;
            }

            button {
                border:0;
                background-color: transparent;
                color: white;
                font-size:16px;
                cursor: pointer;
                width: 40px;
                height: 40px;
                margin:0;
                outline: none;
            }

            button:hover {
                background-color: rgba(255,0,0,.3);
            }

            button[selected], button:active {
                background-color: rgba(247,120,107,1);
                color: black;
            }

            button[disabled] {
                background-color: transparent;
                opacity: 0.5;
                color: white;
            }

            #silk-select-file {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                background-color: rgba(0,0,0,.2);
                font-weight: 600;
                font-size: 24px;
                position: fixed;
                z-index: 2;
                transform: translate(-50%, -50%);
            }

            #silk-select-file:hover {
                background-color: rgba(0,0,0,.4);
                color: white;              
            }

            #silk-select-file:active {
                background-color: rgba(0,0,0,.6);
                color: white;             
            }

            @-webkit-keyframes formattingBarIn {
                0%{
                    opacity: 0;
                    transform: translateY(50%);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @-moz-keyframes formattingBarIn {
                0%{
                    opacity: 0;
                    transform: translateY(50%);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @-o-keyframes formattingBarIn {
                0%{
                    opacity: 0;
                    transform: translateY(50%);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @keyframes formattingBarIn {
                0%{
                    opacity: 0;
                    transform: translateY(50%);
                }
                100% {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>

        <template is="dom-if" if="[[settings.image]]">
        
            <input
                id="file-upload"
                hidden
                type="file"
                on-change="_processImage"
                accept="image/jpeg,image/jpeg,image/png"
                >

            <button
                id="silk-select-file"
                on-tap="insertImage"
                hidden$="[[!fileUploadButtonPosition.top]]"
                style$="top:[[fileUploadButtonPosition.top]]px;left:[[fileUploadButtonPosition.left]]px"
                >+</button>

        </template>

        <section
            class="formatting-bar"
            hidden$="[[nothingSelected]]"
            style$="top:[[formattingBarPosition.top]]px;left:[[formattingBarPosition.left]]px"
            >

            <button
                on-tap="toggleBold"
                disabled$="[[selectedTextHasHeading]]"
                hidden$="[[!settings.bold]]"
                selected$="[[selectedTextIsBold]]"><b>B</b></button>
            <button
                on-tap="toggleItalics"
                disabled$="[[selectedTextHasHeading]]"
                hidden$="[[!settings.italics]]"
                selected$="[[selectedTextIsItalic]]"><i>i</i></button>
            <button
                on-tap="toggleUnderline"
                disabled$="[[selectedTextHasHeading]]"
                hidden$="[[!settings.underline]]"
                selected$="[[selectedTextIsUnderlined]]"><u>U</u></button>
            <button
                on-tap="toggleStrikeThrough"
                disabled$="[[selectedTextHasHeading]]"
                hidden$="[[!settings.strikethrough]]"
                selected$="[[selectedTextIsStrikeThrough]]"><s>S</s></button>
            <button
                on-tap="toggleH1"
                disabled$="[[nothingSelected]]"
                hidden$="[[!settings.h1]]"
                selected$="[[selectedTextHasH1]]">h1</button>
            <button
                on-tap="toggleH2"
                disabled$="[[nothingSelected]]"
                hidden$="[[!settings.h2]]"
                selected$="[[selectedTextHasH2]]">h2</button>
            <button
                on-tap="toggleH3"
                disabled$="[[nothingSelected]]"
                hidden$="[[!settings.h3]]"
                selected$="[[selectedTextHasH3]]">h3</button>
            <button
                on-tap="toggleH4"
                disabled$="[[nothingSelected]]"
                hidden$="[[!settings.h4]]"
                selected$="[[selectedTextHasH4]]">h4</button>
            <button
                on-tap="toggleH5"
                disabled$="[[nothingSelected]]"
                hidden$="[[!settings.h5]]"
                selected$="[[selectedTextHasH5]]">h5</button>
            <button
                on-tap="toggleH6"
                disabled$="[[nothingSelected]]"
                hidden$="[[!settings.h6]]"
                selected$="[[selectedTextHasH6]]">h6</button>
            <button
                on-tap="toggleLink"
                disabled$="[[nothingSelected]]"
                hidden$="[[!settings.link]]"
                selected$="[[selectedTextHaslink]]">&#60;a&#62;</button>
        </section>
        <article
            spellcheck$="[[checkSpelling]]"
            on-focus="_disableSpellcheck"
            on-paste="_pasteHTML"
            on-mouseup="_mouseUpHandler"
            on-keyup="_keyUpHandler"
            on-input="_updateContent"
            contenteditable$="[[!disabled]]"><content></content></article>

    </template>
    <script>
        Polymer({
            
            is: "silk-editor",
            
            properties: {
                disabled: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                checkSpelling: {
                    type: Boolean,
                    value: false
                },
                selection: {
                    type: Object
                },
                selectedText: {
                    type: String,
                    value: null,
                    readOnly: true,
                    notify: true
                },
                article: {
                    type: String,
                    readOnly: true,
                    notify: true,
                    observer: "_articleChanged"
                },
                formattingOptions: {
                    type: String,
                    value: "bold,italics,underline,strikethrough,h1,h2,h3,h4,h5,h6,link,image"
                },
                settings: {
                    type: Object,
                    computed: "_parseSettings(formattingOptions)"
                },
                allowedTags: {
                    type: Array,
                    computed: "_getAllowedTags(settings.*)"
                },
                selectedTextHasHeading: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextHasHeading(selectedText)"
                },
                selectedTextIsBold: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextIsBold(selectedText)"
                },
                selectedTextIsItalic: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextIsItalic(selectedText)"                    
                },
                selectedTextIsUnderlined: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextIsUnderlined(selectedText)"                    
                },
                selectedTextIsStrikeThrough: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextIsStrikeThrough(selectedText)"                    
                },
                selectedTextHasH1: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextHasH1(selectedText)"
                },
                selectedTextHasH2: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextHasH2(selectedText)"
                },
                selectedTextHasH3: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextHasH3(selectedText)"
                },
                selectedTextHasH4: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextHasH4(selectedText)"
                },
                selectedTextHasH5: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextHasH5(selectedText)"
                },
                selectedTextHasH6: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextHasH6(selectedText)"
                },
                selectedTextHaslink: {
                    type: Boolean,
                    value: false,
                    computed: "_selectedTextHasLink(selectedText)"
                },
                nothingSelected: {
                    type: Boolean,
                    value: true,
                    computed: "_getSelectedTextIsEmptyString(selectedText)"
                },
                formattingBarPosition: {
                    type: Object,
                    value: {
                        top: 0,
                        left: 0
                    }
                },
                fileUploadButtonPosition: {
                    type: Object,
                    value: {
                        top: null,
                        left: null
                    }
                },
                resizeImages: {
                    type: Boolean,
                    value: false
                },
                maxImageHeight: {
                    type: Number,
                    value: 2560
                },
                maxImageWidth: {
                    type: Number,
                    value: 2560
                },
                maxImageSize: {
                    type: Number,
                    value: 2000
                }
            },

            ready: function() {
                window.onresize = this._mouseUpHandler.bind(this);
                window.onscroll = this._mouseUpHandler.bind(this);
            },

            _parseSettings: function(formattingOptions) {
                var settings = {};
                var options = formattingOptions.toLowerCase().replace(/\s/g, "").split(/,/g);
                settings["bold"] = options.indexOf("bold") !== -1;
                settings["italics"] = options.indexOf("italics") !== -1;
                settings["underline"] = options.indexOf("underline") !== -1;
                settings["strikethrough"] = options.indexOf("strikethrough") !== -1;
                settings["h1"] = options.indexOf("h1") !== -1;
                settings["h2"] = options.indexOf("h2") !== -1;
                settings["h3"] = options.indexOf("h3") !== -1;
                settings["h4"] = options.indexOf("h4") !== -1;
                settings["h5"] = options.indexOf("h5") !== -1;
                settings["h6"] = options.indexOf("h6") !== -1;
                settings["link"] = options.indexOf("link") !== -1;
                settings["image"] = options.indexOf("image") !== -1;
                return settings;
            },

            toggleBold: function() {
                if(!this.settings.bold) return console.warn("bold is disabled!");
                document.execCommand("Bold")
            },

            toggleItalics: function() {
                if(!this.settings.italics) return console.warn("italics is disabled!");
                document.execCommand("Italic")
            },

            toggleUnderline: function() {
                if(!this.settings.underline) return console.warn("underline is disabled!");
                document.execCommand("Underline")
            },

            toggleStrikeThrough: function() {
                if(!this.settings.strikethrough) return console.warn("strikethrough is disabled!");
                document.execCommand("StrikeThrough")
            },

            toggleH1: function() {
                if(!this.settings.h1) return console.warn("h1 is disabled!");
                if(this._selectedTextHasH1()) return this.removeFormatting();
                this._addHTML("h1");
            },

            toggleH2: function() {
                if(!this.settings.h2) return console.warn("h2 is disabled!");
                if(this._selectedTextHasH2()) return this.removeFormatting();
                this._addHTML("h2");
            },

            toggleH3: function() {
                if(!this.settings.h3) return console.warn("h3 is disabled!");
                if(this._selectedTextHasH3()) return this.removeFormatting();
                this._addHTML("h3");
            },

            toggleH4: function() {
                if(!this.settings.h4) return console.warn("h4 is disabled!");
                if(this._selectedTextHasH4()) return this.removeFormatting();
                this._addHTML("h4");
            },

            toggleH5: function() {
                if(!this.settings.h5) return console.warn("h5 is disabled!");
                if(this._selectedTextHasH5()) return this.removeFormatting();
                this._addHTML("h5");
            },

            toggleH6: function() {
                if(!this.settings.h6) return console.warn("h6 is disabled!");
                if(this._selectedTextHasH6()) return this.removeFormatting();
                this._addHTML("h6");
            },

            toggleLink: function() {
                if(!this.settings.link) return console.warn("link is disabled!");
                var selectedElement = this._getSelectionRange().startContainer.parentElement;
                var url = window.prompt("Please add a link", selectedElement.href || "http://");
                if(!url || url.length === 0) return this.removeLink();
                else this.insertLink(url);
            },

            insertLink: function(url) {
                if(!this.settings.link) return console.warn("link is disabled!");
                document.execCommand("insertHTML", false, "<a href=\""+url+"\">"+this.selectedText+"</a>");
            },

            removeLink: function() {
                if(!this.settings.link) return console.warn("link is disabled!");
                document.execCommand("unlink", false);
            },

            _getSelection: function() {
               var selection = "";

                if (window.getSelection) {  // all browsers, except IE before version 9
                    if (document.activeElement && (document.activeElement.tagName.toLowerCase() == "textarea" || document.activeElement.tagName.toLowerCase() == "input")) {
                        var text = document.activeElement.value;
                        selection = text.substring(document.activeElement.selectionStart, document.activeElement.selectionEnd);
                    }
                    else {
                        selection = window.getSelection();
                    }
                }
                else {
                    if (document.selection.createRange) { // Internet Explorer
                        selection = document.selection.createRange();
                    }
                }
                this._setSelectedText(selection.toString() || selection.text);
                return selection;
            },

            _getSelectionRange: function() {
                try {
                    return this._getSelection().getRangeAt(0);
                } catch(e) {
                    return false;
                }
            },

            _getSelectedElement: function() {
                return this._getSelectionRange().startContainer.parentElement;   
            },

            _getFormattingBarPosition: function() {
                var range = this._getSelectionRange();
                if(!range) return;
                if(!range.getClientRects()[0]) return;
                if (range.getClientRects()[0].width === 0 && range.getClientRects()[1]) {
                    var topPosition = range.getClientRects()[1].top;
                    var leftPosition = range.startContainer.parentElement.offsetLeft;
                } else {
                    var topPosition = range.getClientRects()[0].top;
                    var leftPosition = range.getClientRects()[0].left;                    
                }
                topPosition -= this._getSelectedHeight() || 0;
                topPosition -= this._getSelectedLineHeight() || 0;
                return {
                    top: topPosition,
                    left: leftPosition
                }
            },

            _getFileUploadButtonPosition: function() {
                var selectedElement = this._getSelectionRange().startContainer;
                if(!selectedElement.getClientRects) return false;
                if(!selectedElement || !selectedElement.getClientRects) return false;
                if(!selectedElement.getClientRects()[0]) return false;
                if (selectedElement.getClientRects()[0].width === 0 && selectedElement.getClientRects()[1]) {
                    var topPosition = selectedElement.getClientRects()[1].top;
                    var leftPosition = selectedElement.startContainer.parentElement.offsetLeft;
                } else {
                    var topPosition = selectedElement.getClientRects()[0].top;
                    var leftPosition = selectedElement.getClientRects()[0].left;                    
                }
                return {
                    top: topPosition,
                    left: leftPosition
                }
            },

            insertImage: function() {
                this.$$("#file-upload").click();
            },

            _getScrollTop: function() {
                var element = (navigator.userAgent.indexOf("Firefox") !== -1) ? document.documentElement : document.body;
                return element.scrollTop;
            },

            _getScrollLeft: function() {
                var element = (navigator.userAgent.indexOf("Firefox") !== -1) ? document.documentElement : document.body;
                return element.scrollLeft;
            },

            _mouseUpHandler: function(e) {
                this.set("formattingBarPosition", this._getFormattingBarPosition());
                this.set("fileUploadButtonPosition", this._getFileUploadButtonPosition());
            },

            _keyUpHandler: function(e) {
                this.set("fileUploadButtonPosition", this._getFileUploadButtonPosition());
            },

            _disableSpellcheck: function() {
                if(!this.checkSpelling) document.body.spellcheck = false;
            },

            _pasteHTML: function(e) {
                if (e.originalEvent && e.originalEvent.clipboardData && e.originalEvent.clipboardData.getData) {
                    e.preventDefault();
                    var html = this._stripTags(e.originalEvent.originalEvent.clipboardData.getData("text/html"));
                    window.document.execCommand("insertHTML", false, html);
                }
                else if (e.clipboardData && e.clipboardData.getData) {
                    e.preventDefault();
                    var html = this._stripTags(e.clipboardData.getData("text/html"));
                    window.document.execCommand("insertHTML", false, html);
                }
                else if (window.clipboardData && window.clipboardData.getData) {
                    if (!_onPaste_StripFormatting_IEPaste) {
                        _onPaste_StripFormatting_IEPaste = true;
                        e.preventDefault();
                        window.document.execCommand("ms-pasteTextOnly", false);
                    }
                    _onPaste_StripFormatting_IEPaste = false;
                }
            },

            removeFormatting: function() {
                var selectedTag = this._getSelectionRange().startContainer.parentNode;
                var text = selectedTag.innerHTML;
                document.execCommand("formatBlock", false, 'p');
            },

            _stripTags: function(input, allowed) {
                allowed = this.allowedTags.join(",");
                var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
                return this._stripAttributes(input.replace(tags, function($0, $1) {
                    return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
                }), "href,src");
            },

            _stripAttributes: function(input, allowed) {
                allowed = ((allowed || "") + "")
                    .toLowerCase()
                    .split(/,/g);
                var attributes = /\s(([a-z]|[0-9]|\-)+=".*?")/gi;
                return input.replace(attributes, function(input, attribute) {
                    var attributeName = attribute.replace(/^(.*?)=.*?$/, "$1");
                    return allowed.indexOf(attributeName.toLowerCase()) > -1 ? input : '';
                });
            },

            _getComputedStylesForElement: function(element) {
                var getComputedStyles = window.getComputedStyle || document.defaultView.getComputedStyle;
                return getComputedStyles(element);
            },

            _getSelectedFontSize: function() {
                var fontSize = this._getComputedStylesForElement(this._getSelectedElement()).getPropertyValue("font-size");
                return parseInt(fontSize.replace("px", ""));
            },

            _getSelectedHeight: function() {
                var height = this._getComputedStylesForElement(this.$$(".formatting-bar")).getPropertyValue("height");
                return parseInt(height.replace("px", ""));
            },

            _getSelectedLineHeight: function() {
                var lineHeight = this._getComputedStylesForElement(this._getSelectedElement()).getPropertyValue("line-height");
                return parseInt(lineHeight.replace("px", ""));
            },

            _addHTML: function(elementName) {
                if(!this.selectedText || this.selectedText.length === 0) return;
                document.execCommand("insertHTML", false, "<" + elementName + ">" + this.selectedText + "</" + elementName + ">")
            },

            _selectedTextIsBold: function() {
                return document.queryCommandState("Bold");
            },

            _selectedTextIsItalic: function() {
                return document.queryCommandState("Italic");                
            },

            _selectedTextIsUnderlined: function() {
                return document.queryCommandState("Underline");                
            },

            _selectedTextIsStrikeThrough: function() {
                return document.queryCommandState("StrikeThrough");                
            },

            _selectedTextHasLink: function() {
                if(!this._getSelectionRange()) return false;
                var selectedElement = this._getSelectionRange().startContainer.parentElement;
                return (selectedElement.href && selectedElement.href.length > 0);
            },

            _selectedTextHasTag: function(tagName) {
                if(!this._getSelectionRange()) return false;
                var selectedElement = this._getSelectionRange().startContainer.parentElement;
                return selectedElement.nodeName.toLowerCase() === tagName;
            },

            _selectedTextHasHeading: function() {
                return (this._selectedTextHasH1() || this._selectedTextHasH2() || this._selectedTextHasH3() || this._selectedTextHasH4() || this._selectedTextHasH5() || this._selectedTextHasH6())
            },

            _selectedTextHasH1: function() {
                return this._selectedTextHasTag("h1");
            },

            _selectedTextHasH2: function() {
                return this._selectedTextHasTag("h2");
            },

            _selectedTextHasH3: function() {
                return this._selectedTextHasTag("h3");
            },

            _selectedTextHasH4: function() {
                return this._selectedTextHasTag("h4");
            },

            _selectedTextHasH5: function() {
                return this._selectedTextHasTag("h5");
            },

            _selectedTextHasH6: function() {
                return this._selectedTextHasTag("h6");
            },

            _updateContent: function() {
                this._setArticle(this.$$("article").innerHTML);
                this._mouseUpHandler();
            },

            _getAllowedTags: function() {
                var allowedTags = [];
                var settings = this.settings;
                if(settings["bold"]) allowedTags.push("<b>", "<strong>");
                if(settings["italics"]) allowedTags.push("<i>", "<em>");
                if(settings["underline"]) allowedTags.push("<u>");
                if(settings["strikethrough"]) allowedTags.push("<s>");
                if(settings["h1"]) allowedTags.push("<h1>");
                if(settings["h2"]) allowedTags.push("<h2>");
                if(settings["h3"]) allowedTags.push("<h3>");
                if(settings["h4"]) allowedTags.push("<h4>");
                if(settings["h5"]) allowedTags.push("<h5>");
                if(settings["h6"]) allowedTags.push("<h6>");
                if(settings["link"]) allowedTags.push("<a>");
                if(settings["image"]) allowedTags.push("<img>");
                return allowedTags;
            },

            _articleChanged: function() {
                this._setSelectedText(new String(this.selectedText));
            },

            _getSelectedTextIsEmptyString: function(selectedText) {
                return (!selectedText || selectedText.length === 0);
            },

            _processImage: function(e) {
                if(!this.settings.image) return console.warn("image upload is disabled!");
                var self = this;
                var file = e.target.files[0];

                var maximumFileSizeInBytes = this.maxImageSize*1000;
                if(file.size > maximumFileSizeInBytes) {
                    return this.fire("image-upload-error", "maxium upload size exceeded ("+ this.maxImageSize+"KB)");
                }

                var fileType = file.type;
                var reader = new FileReader();
                reader.onloadend = function () {
                    var imageData = reader.result;
                    if(self.resizeImages) imageData = self._resizeImage(imageData, fileType);
                    document.execCommand("insertHTML", false, '<img src="'+imageData+'">');
                    self.$$("#file-upload").value = "";
                }
                reader.readAsDataURL(file);
            },

            _resizeImage: function(fileReaderData, fileType) {
                var img = document.createElement("img");
                img.src = fileReaderData;
                imageWidth = img.width;
                imageHeight = img.height;

                if(imageHeight <= this.maxImageHeight && imageWidth <= this.maxImageWidth) {
                    return fileReaderData;  
                } 

                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);

                if (imageWidth > imageHeight) {
                    if (imageWidth > this.maxImageWidth) {
                        imageHeight *= this.maxImageWidth / imageWidth;
                        imageWidth = this.maxImageWidth;
                    }
                } else {
                    if (imageHeight > this.maxImageHeight) {
                        imageWidth *= this.maxImageHeight / imageHeight;
                        imageHeight = this.maxImageHeight;
                    }
                }
                canvas.width = imageWidth;
                canvas.height = imageHeight;

                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, imageWidth, imageHeight);

                var dataurl = canvas.toDataURL(fileType);
                return dataurl;
            }

        })
    </script>
</dom-module>