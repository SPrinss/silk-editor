<link rel="import" href="../polymer/polymer.html">

<!--
`silk-editor`


@demo demo/index.html
-->

<dom-module id="silk-editor">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <button on-tap="_toggleBold">Bold</button>
    <button on-tap="_toggleItalic">Italic</button>
    <button on-tap="_toggleUnderline">Underline</button>
    <button on-tap="_toggleStrikethrough">Strikethrough</button>

    <article
      contenteditable="true"
      on-focus="_handleFocus"
      on-blur="_handleBlur"
      on-input="_handleInput"
    ></article>
  </template>

  <script>
    Polymer({

      is: 'silk-editor',

      behaviors: [
        Polymer.IronA11yKeysBehavior
      ],

      properties: {
        
        content: {
          type: String,
          value: 'Hello, this is silk-editor',
          notify: true
        },
        
        focused: {
          type: Boolean,
          value: false,
        },

        selection: {
          type: Object
        },

        selectedText: {
          type: String,
          value: '',
          observer: '_selectedTextChanged'
        },

      },

      keyBindings: {
        'esc': '_handleKeyEscape',
        'enter': '_handleKeyEnter',
        'shift+enter': '_handleKeyShiftEnter'
      },

      observers: [
        '_setHTML(content, focused)'
      ],

      ready: function() {
        document.addEventListener('selectionchange', this._handleSelectionChange.bind(this));
      },

      _handleSelectionChange: function(evt) {
        console.info('selectionchange');
        this.selection = this._getSelection();
        this.selectedText = (this.selection) ? this.selection.toString() : '';
      },

      _selectedTextChanged: function(selectedText, oldSelectedText) {
        console.info('_selectedTextChanged');
        if(! (this.selection && this.selection.getRangeAt) ) return;
        if(selectedText) {
          this.selection.addRange(this.selection.getRangeAt(0));
        }
      },

      _handleFocus: function() {
        console.info('focus');
        this.focused = true;
      },

      _handleBlur: function() {
        console.info('blur');
        this.focused = false;
      },

      _handleInput: function(evt) {
        console.info('input');
        var content = evt.target.innerHTML;
        this.content = content;
      },

      _setHTML: function(content, focused, selectedText) {
        if(focused === true) {
          return;
        }
        if(this.selection && this.selection.getRangeAt(0)) {
          return;
        }
        console.info('set HTML');
        this.$$('article').innerHTML = content;
      },

      _handleKeyEscape: function() {
        console.info('_handleKeyEscape');
        this.$$('article').blur();
      },

      _handleKeyEnter: function() {
        console.info('_handleKeyEnter');
      },

      _handleKeyShiftEnter: function() {
        console.info('_handleKeyShiftEnter');
      },

      _getSelection: function() {
        return window.getSelection();
      },

      _toggleBold: function(evt) {
        console.info('_toggleBold');
        document.execCommand('Bold');
      },

      _toggleItalic: function() {
        console.info('_toggleItalic');
        document.execCommand('Italic');        
      },

      _toggleUnderline: function() {
        console.info('_toggleUnderline');
        document.execCommand('Underline');        
      },

      _toggleStrikethrough: function() {
        console.info('_toggleStrikethrough');
        document.execCommand('Strikethrough');        
      }

    });
  </script>
</dom-module>
