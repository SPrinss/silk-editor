<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/editor-icons.html">
<link rel="import" href="../paper-styles/color.html">

<!--
`silk-editor`


@demo demo/index.html
-->

<dom-module id="silk-editor">
  <template>
    <style>
      :host {
        display: block;
        padding: 0;
        margin: 0;
        
        --silk-formatting-bar: {
          position: fixed;
          z-index: 1;
          visibility: visible;
          opacity: 1;
          display: flex;
          align-items: center;
          border: 1px solid var(--paper-grey-300);
          box-shadow: 0px 2px 1px 0px var(--paper-grey-400);
          padding: 3px 6px;
          border-radius: 5px;
          background-color: white;
          transition: 0.3s 0.1s opacity, 0.1s visibility, 0.1s 0.1s transform ease-in-out;
          transform: translateY(0);
        };

        --silk-formatting-bar-hidden: {
          visibility: hidden;
          opacity: 0;
          transform: translateY(16px);
          transition: 0.1s opacity, 0.1s visibility, 0.1s transform ease-in-out;
        }

        --formatting-button: {
          background-color: transparent;
          border: 0;
          outline: none;
          cursor: pointer;
          border: 1px solid transparent;
          border-radius: 3px;
          margin: 5px 2px;
        };

        --formatting-button-hover: {
          border-color: var(--paper-grey-300);
          color: var(--paper-pink-500);
        }

        --formatting-button-disabled: {
          opacity: 0.5;
          pointer-events: none;
        }

        --formatting-button-selected: {
          border-color: var(--paper-pink-300);
          color: var(--paper-pink-500);
          background-color: var(--paper-pink-100);
        }

        --formatting-button-icon-size: 22px;

        --silk-input: {
          width: 0;
          transition: 0.4s width;
          padding: 0;
          font-size: 0;
          border: 0 solid transparent;
          border-radius: 3px;
          outline: none;
          font-family: -apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif;
          color: var(--paper-grey-800);
          font-size: 13px;
          line-height: 1.5;
          outline: none;
        }

        --silk-input-focus: {
          border: 1px solid var(--paper-pink-300);
          padding: 6px;
        }

        --silk-input-enabled: {
          width: 160px;
        }

      }

      button {
        @apply --formatting-button;
      }

      iron-icon {
        width: var(--formatting-button-icon-size);
        height: var(--formatting-button-icon-size);
      }

      button:hover {
        @apply --formatting-button-hover;
      }

      button[disabled] {
        @apply --formatting-button-hover;
      }

      button[data-selected] {
        @apply --formatting-button-selected;
      }

      #formatting-bar {
        @apply --silk-formatting-bar;
      }

      #formatting-bar[data-hidden] {
        @apply --silk-formatting-bar-hidden;
      }

      #formatting-bar[data-link-input-focused] {
        visibility: visible;
        opacity: 1;
      }

      #link-input {
        @apply --silk-input;
      }

      #link-input:focus {
        @apply --silk-input-focus;
      }

      #formatting-bar[data-show-link-input] #link-input {
        @apply --silk-input-enabled;
      }

      [hidden] {
        display: none!important;
      }
    </style>

    <section
      id="formatting-bar"
      data-hidden$="[[!selectedText]]"
      data-show-link-input$="[[showLinkInput]]"
      data-link-input-focused$="[[_linkInputFocused]]"
      >

      <button
        disabled$="[[!selectedText]]"
        data-selected$="[[_stateEnabled('Bold', selectedText, content)]]"
        on-tap="_toggleBold"
        hidden$="[[!bold]]"
      ><iron-icon icon="editor:format-bold"></iron-icon>
      </button>

      <button
        disabled$="[[!selectedText]]"
        data-selected$="[[_stateEnabled('Italic', selectedText, content)]]"
        on-tap="_toggleItalic"
        hidden$="[[!italic]]"
      ><iron-icon icon="editor:format-italic"></iron-icon>
      </button>

      <button
        disabled$="[[!selectedText]]"
        data-selected$="[[_stateEnabled('Underline', selectedText, content)]]"
        on-tap="_toggleUnderline"
        hidden$="[[!underline]]"
      ><iron-icon icon="editor:format-underlined"></iron-icon>
      </button>

      <button
        disabled$="[[!selectedText]]"
        data-selected$="[[_stateEnabled('Strikethrough', selectedText, content)]]"
        on-tap="_toggleStrikethrough"
        hidden$="[[!strikethrough]]"
      ><iron-icon icon="editor:format-strikethrough"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('JustifyLeft', selectedText, content)]]"
        on-tap="_alignLeft"
        hidden$="[[!alignLeft]]"
      ><iron-icon icon="editor:format-align-left"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('JustifyCenter', selectedText, content)]]"
        on-tap="_alignCenter"
        hidden$="[[!alignCenter]]"
      ><iron-icon icon="editor:format-align-center"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('JustifyRight', selectedText, content)]]"
        on-tap="_alignRight"
        hidden$="[[!alignRight]]"
      ><iron-icon icon="editor:format-align-right"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('JustifyFull', selectedText, content)]]"
        on-tap="_alignJustified"
        hidden$="[[!alignJustified]]"
      ><iron-icon icon="editor:format-align-justify"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('indent', selectedText, content)]]"
        on-tap="_indent"
        hidden$="[[!indent]]"
      ><iron-icon icon="editor:format-indent-increase"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('outdent', selectedText, content)]]"
        on-tap="_outdent"
        hidden$="[[!indent]]"
      ><iron-icon icon="editor:format-indent-decrease"></iron-icon>
      </button>

      <input
        type="text"
        id="link-input"
        placeholder="Please type in a url..."
        on-keypress="_handleInputKeypress"
        on-focus="_handleInputFocus"
        on-blur="_handleInputBlur"
      >

      <button
        data-selected$="[[_currentSelectionIsLink]]"
        on-tap="_handleTapLinkButton"
        hidden$="[[!link]]"
      ><iron-icon icon="editor:insert-link"></iron-icon>
      </button>

    </section>

  </template>

  <script>
    Polymer({

      is: 'silk-editor',

      properties: {

        for: {
          type: String,
          observer: '_initElementEvents'
        },
        
        content: {
          type: String,
          notify: true,
          readOnly: true
        },

        bold: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        italic: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        underline: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        strikethrough: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        alignLeft: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        
        alignCenter: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        
        alignRight: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        
        alignJustified: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        
        indent: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        
        link: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        
        focused: {
          type: Boolean,
          value: false,
        },

        selection: {
          type: Object
        },

        selectedText: {
          type: String,
          value: '',
          observer: '_selectedTextChanged'
        },

        showLinkInput: {
          type: Boolean,
          value: false
        },

        _savedRange: {
          type: Object
        },

        _currentSelectionIsLink: {
          type: Boolean,
          computed: '_computeCurrentSelectionIsLink(selectedText)'
        },

        _linkInputFocused: {
          type: Boolean,
          value: false,
          observer: '_linkInputFocusedChanged'
        }

      },

      ready: function() {
        document.addEventListener('selectionchange', this._handleSelectionChange.bind(this));
      },

      _initElementEvents: function(elementId) {
        var element = this._getElement();
        
        element.addEventListener('focus', (function() {
          this.focused = true;
        }).bind(this));
        
        element.addEventListener('blur', (function() {
          this.focused = false;
        }).bind(this));
        
        element.addEventListener('input', (function(evt) {
          this._handleInput(evt);
        }).bind(this));

        element.addEventListener('change', (function(evt) {
          this._handleInput(evt);
        }).bind(this));

        this._observer = Polymer.dom(element).observeNodes((function() {
          this._setContent(element.innerHTML);
        }).bind(this));

      },

      _stateEnabled: function(state) {
        return document.queryCommandState(state);
      },

      _handleSelectionChange: function(evt) {
        if(this._linkInputFocused) return;

        this._unhighlightElements();
        this.showLinkInput = false;
        
        this.selection = this._getSelection();
        this.selectedText = (this.selection) ? this.selection.toString() : '';
      },

      _handleInputFocus: function() {
        this._linkInputFocused = true;
      },

      _handleInputBlur: function() {
        this._linkInputFocused = false;
      },

      _handleInputKeypress: function(evt) {
        var url = evt.target.value;
        if(evt.which === 13) {
          this._insertLink(url);
        }
      },

      _selectedTextChanged: function(selectedText) {
        if(! (this.selection && this.selection.getRangeAt) ) return;
        if(selectedText) {
          var range = this.selection.getRangeAt(0);
          this.selection.addRange(range);
          this._saveRange();
          this._moveFormattingBar();
          this.updateStyles();
        }
      },

      _moveFormattingBar: function() {        
        var formattingBar = this.$$('#formatting-bar');
        var formattingBarBox = formattingBar.getBoundingClientRect();

        var selectionBox = this._savedRange.getBoundingClientRect();
        formattingBar.style.top = (selectionBox.top - formattingBarBox.height - 16) + 'px';
        formattingBar.style.left = (selectionBox.left - (formattingBarBox.width/2)) + (selectionBox.width/2) + 'px';
      },

      _handleFocus: function() {
        this.focused = true;
      },

      _handleBlur: function() {
        this.focused = false;
      },

      _handleInput: function(evt) {
        var content = evt.target.innerHTML;
        this._setContent(content);
      },

      _getSelection: function() {
        var element = window;
        return element.getSelection();
      },

      _toggleBold: function(evt) {
        document.execCommand('Bold');
      },

      _toggleItalic: function() {
        document.execCommand('Italic');
      },

      _toggleUnderline: function() {
        document.execCommand('Underline');
      },

      _toggleStrikethrough: function() {
        document.execCommand('Strikethrough');
      },

      _alignLeft: function() {
        document.execCommand('JustifyLeft');
      },

      _alignCenter: function() {
        document.execCommand('JustifyCenter');
      },

      _alignRight: function() {
        document.execCommand('JustifyRight');
      },

      _alignJustified: function() {
        document.execCommand('JustifyFull');
      },

      _indent: function() {
        document.execCommand('Indent');
      },

      _outdent: function() {
        document.execCommand('Outdent');
      },

      _handleTapLinkButton: function() {
        if(this._currentSelectionIsLink) {
          var element = this._savedRange.startContainer.parentElement;
          element.outerHTML = element.innerHTML;
          this.selectedText = '';
        } else {
          this.showLinkInput = true;
          window.setTimeout((function() {
            this.$$('#link-input').focus();
          }).bind(this), 40)
        }
      },

      _saveRange: function() {
        this._savedRange = this._getSelection().getRangeAt(0);
      },

      _getElement: function() {
        if(!this.for) return {};
        var elem = this.domHost.querySelector('#' + this.for);
        return elem;
      },

      _linkInputFocusedChanged: function(linkInputFocused) {
        if(linkInputFocused) {

          if(this._savedRange.startContainer.parentElement.classList.contains('silk-highlight')) {
            return;
          }

          var span = document.createElement('span');
          span.className = 'silk-highlight';
          span.style.backgroundColor = '#b2d7ff';
          this._savedRange.surroundContents(span);

        }
      },
 
      _computeCurrentSelectionIsLink: function() {
        try {
          var isLink = this._getSelection().getRangeAt && this._getSelection()
          .getRangeAt(0)
          .startContainer
          .parentElement
          .nodeName.toLowerCase() === 'a';
          return isLink;
        } catch(e) {
          return false;
        }
      },

      _toggleLink: function() {
        this._insertLink(this.$$('#link-input').value);
      },

      _insertLink: function(url) {
        if(!url) return;
        var selection = this._getSelection();
        selection.removeAllRanges();
        selection.addRange(this._savedRange);

        document.execCommand('CreateLink', false, url);
        var selectedText = this.selectedText;
        this.set('selectedText', '');
        this.set('selectedText', selectedText);

        this.$$('#link-input').value = '';

      },

      _unhighlightElements: function() {
        var highlightedElements = Array.from(this._getElement().querySelectorAll('.silk-highlight'));
        for(var i in highlightedElements) {
          highlightedElements[i].outerHTML = highlightedElements[i].innerHTML;
        }
      },

    });
  </script>
</dom-module>
