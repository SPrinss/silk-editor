<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/editor-icons.html">

<!--
`silk-editor`


@demo demo/index.html
-->

<dom-module id="silk-editor">
  <template>
    <style>
      :host {
        display: block;
        padding: 0;
        margin: 0;
        
        --silk-formatting-bar: {
          border: 1px solid var(--paper-grey-300);
          box-shadow: 0px 2px 1px 0px var(--paper-grey-400);
          padding: 3px 6px;
          border-radius: 5px;
          background-color: white;
          transition: 0.3s 0.1s opacity, 0.1s visibility, 0.1s 0.1s transform ease-in-out;
          transform: translateY(0);
        };

        --silk-formatting-bar-hidden: {
          transform: translateY(16px);
          transition: 0.1s opacity, 0.1s visibility, 0.1s transform ease-in-out;
        }

        --formatting-button: {
          background-color: transparent;
          border: 0;
          outline: none;
          cursor: pointer;
          border: 1px solid transparent;
          border-radius: 3px;
          margin: 5px 2px;          
        };

        --formatting-button-hover: {
          border-color: var(--paper-grey-300);
          color: var(--paper-pink-500);          
        }

        --formatting-button-disabled: {
          opacity: 0.5;
          pointer-events: none;          
        }

        --formatting-button-selected: {
          border-color: var(--paper-pink-300);
          color: var(--paper-pink-500);
          background-color: var(--paper-pink-100);          
        }

        --formatting-button-icon-size: 22px;

      }

      button {
        @apply --formatting-button;
      }

      iron-icon {
        width: var(--formatting-button-icon-size);
        height: var(--formatting-button-icon-size);              
      }

      button:hover {
        @apply --formatting-button-hover;
      }

      button[disabled] {
        @apply --formatting-button-hover;
      }

      button[data-selected] {
        @apply --formatting-button-selected;
      }

      article {
        font-family: Georgia;
        color: var(--paper-grey-800);
        font-size: 18px;
        line-height: 1.5;
        outline: none;
      }

      #formatting-bar {
        position: fixed;
        z-index: 1;
        visibility: visible;
        opacity: 1;
        @apply --silk-formatting-bar;
      }

      #formatting-bar[data-hidden] {
        visibility: hidden;
        opacity: 0;
        @apply --silk-formatting-bar-hidden;
      }

      [hidden] {
        display: none!important;
      }
    </style>

    <section id="formatting-bar" data-hidden$="[[!selectedText]]">

      <button
        disabled$="[[!selectedText]]"
        data-selected$="[[_stateEnabled('Bold', selectedText, content)]]"
        on-tap="_toggleBold"
        hidden$="[[!bold]]"
      ><iron-icon icon="editor:format-bold"></iron-icon>
      </button>

      <button
        disabled$="[[!selectedText]]"
        data-selected$="[[_stateEnabled('Italic', selectedText, content)]]"
        on-tap="_toggleItalic"
        hidden$="[[!italic]]"
      ><iron-icon icon="editor:format-italic"></iron-icon>
      </button>

      <button
        disabled$="[[!selectedText]]"
        data-selected$="[[_stateEnabled('Underline', selectedText, content)]]"
        on-tap="_toggleUnderline"
        hidden$="[[!underline]]"
      ><iron-icon icon="editor:format-underlined"></iron-icon>
      </button>

      <button
        disabled$="[[!selectedText]]"
        data-selected$="[[_stateEnabled('Strikethrough', selectedText, content)]]"
        on-tap="_toggleStrikethrough"
        hidden$="[[!strikethrough]]"
      ><iron-icon icon="editor:format-strikethrough"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('JustifyLeft', selectedText, content)]]"
        on-tap="_alignLeft"
        hidden$="[[!alignLeft]]"
      ><iron-icon icon="editor:format-align-left"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('JustifyCenter', selectedText, content)]]"
        on-tap="_alignCenter"
        hidden$="[[!alignCenter]]"
      ><iron-icon icon="editor:format-align-center"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('JustifyRight', selectedText, content)]]"
        on-tap="_alignRight"
        hidden$="[[!alignRight]]"
      ><iron-icon icon="editor:format-align-right"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('JustifyFull', selectedText, content)]]"
        on-tap="_alignJustified"
        hidden$="[[!alignJustified]]"
      ><iron-icon icon="editor:format-align-justify"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('indent', selectedText, content)]]"
        on-tap="_indent"
        hidden$="[[!indent]]"
      ><iron-icon icon="editor:format-indent-increase"></iron-icon>
      </button>

      <button
        data-selected$="[[_stateEnabled('outdent', selectedText, content)]]"
        on-tap="_outdent"
        hidden$="[[!indent]]"
      ><iron-icon icon="editor:format-indent-decrease"></iron-icon>
      </button>

    </section>

    <article
      contenteditable="true"
      spellcheck="false"
      on-focus="_handleFocus"
      on-blur="_handleBlur"
      on-input="_handleInput"
    ></article>
  </template>

  <script>
    Polymer({

      is: 'silk-editor',

      behaviors: [
        Polymer.IronA11yKeysBehavior
      ],

      properties: {
        
        content: {
          type: String,
          notify: true,
        },

        bold: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        italic: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        underline: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        strikethrough: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        alignLeft: {
          type: Boolean,
          value: false,
          reflectToAttribute: true          
        },
        
        alignCenter: {
          type: Boolean,
          value: false,
          reflectToAttribute: true          
        },
        
        alignRight: {
          type: Boolean,
          value: false,
          reflectToAttribute: true          
        },
        
        alignJustified: {
          type: Boolean,
          value: false,
          reflectToAttribute: true          
        },
        
        indent: {
          type: Boolean,
          value: false,
          reflectToAttribute: true          
        },
        
        focused: {
          type: Boolean,
          value: false,
        },

        selection: {
          type: Object
        },

        selectedText: {
          type: String,
          value: '',
          observer: '_selectedTextChanged'
        },

        _savedRange: {
          type: Object
        }

      },

      keyBindings: {
        'esc': '_handleKeyEscape',
      },

      observers: [
        '_setHTML(content, focused)'
      ],

      ready: function() {
        document.addEventListener('selectionchange', this._handleSelectionChange.bind(this));
      },

      _stateEnabled: function(state) {
        return document.queryCommandState(state);
      },

      _handleSelectionChange: function(evt) {
        this.selection = this._getSelection();
        this.selectedText = (this.selection) ? this.selection.toString() : '';
      },

      _selectedTextChanged: function(selectedText, oldSelectedText) {
        if(! (this.selection && this.selection.getRangeAt) ) return;
        if(selectedText) {
          var range = this.selection.getRangeAt(0);
          this.selection.addRange(range);
          this._saveRange();
          this._moveFormattingBar();
          this.updateStyles();
        }
      },

      _moveFormattingBar: function() {        
        var formattingBar = this.$$('#formatting-bar');
        var formattingBarBox = formattingBar.getBoundingClientRect();

        var selectionBox = this._savedRange.getBoundingClientRect();
        formattingBar.style.top = (selectionBox.top - formattingBarBox.height - 16) + 'px';
      },

      _handleFocus: function() {
        this.focused = true;
      },

      _handleBlur: function() {
        this.focused = false;
      },

      _handleInput: function(evt) {
        var content = evt.target.innerHTML;
        this.content = content;
      },

      _setHTML: function(content, focused, selectedText) {
        if(focused === true) {
          return;
        }
        if(this.selection && this.selection.getRangeAt) {
          return;
        }
        this._getElement().innerHTML = content;
      },

      _handleKeyEscape: function() {
        this._getElement().blur();
      },

      _getSelection: function() {
        var element = this.shadowRoot || window;
        return element.getSelection();
      },

      _toggleBold: function(evt) {
        document.execCommand('Bold');
      },

      _toggleItalic: function() {
        document.execCommand('Italic');        
      },

      _toggleUnderline: function() {
        document.execCommand('Underline');        
      },

      _toggleStrikethrough: function() {
        document.execCommand('Strikethrough');        
      },

      _alignLeft: function() {
        document.execCommand('JustifyLeft');
      },

      _alignCenter: function() {
        document.execCommand('JustifyCenter');
      },

      _alignRight: function() {
        document.execCommand('JustifyRight');
      },

      _alignJustified: function() {
        document.execCommand('JustifyFull');
      },

      _indent: function() {
        document.execCommand('Indent');
      },

      _outdent: function() {
        document.execCommand('Outdent');
      },

      _saveRange: function() {
        if(window.getSelection) { //non IE Browsers
          this._savedRange = this._getSelection().getRangeAt(0);
        }
        else if(document.selection) { //IE
          this._savedRange = document.selection.createRange();
        }
      },

      _restoreRange: function() {
        this._getElement().focus();
        if (this._savedRange != null) {
          //modern browsers
          if (window.getSelection || this.shadowRoot.getSelection) {
            var selection = this._getSelection();
            selection.removeAllRanges();              
            selection.addRange(this._savedRange);
          }
          //IE
          else {
            this._savedRange.select();
          }
        }
      },

      _getElement: function() {
        return this.$$('article');
      }

    });
  </script>
</dom-module>
